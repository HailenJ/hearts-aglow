import{S as W}from"./index-DkIouUHk.js";const P=/_key\s*==\s*['"](.*)['"]/;function R(e){return typeof e=="string"?P.test(e.trim()):typeof e=="object"&&"_key"in e}function j(e){if(!Array.isArray(e))throw new Error("Path is not an array");return e.reduce((t,n,r)=>{const o=typeof n;if(o==="number")return`${t}[${n}]`;if(o==="string")return`${t}${r===0?"":"."}${n}`;if(R(n)&&n._key)return`${t}[_key=="${n._key}"]`;if(Array.isArray(n)){const[c,s]=n;return`${t}[${c}:${s}]`}throw new Error(`Unsupported path segment \`${JSON.stringify(n)}\``)},"")}const k={"\f":"\\f","\n":"\\n","\r":"\\r","	":"\\t","'":"\\'","\\":"\\\\"},w={"\\f":"\f","\\n":`
`,"\\r":"\r","\\t":"	","\\'":"'","\\\\":"\\"};function q(e){return`$${e.map(t=>typeof t=="string"?`['${t.replace(/[\f\n\r\t'\\]/g,n=>k[n])}']`:typeof t=="number"?`[${t}]`:t._key!==""?`[?(@._key=='${t._key.replace(/['\\]/g,n=>k[n])}')]`:`[${t._index}]`).join("")}`}function v(e){const t=[],n=/\['(.*?)'\]|\[(\d+)\]|\[\?\(@\._key=='(.*?)'\)\]/g;let r;for(;(r=n.exec(e))!==null;){if(r[1]!==void 0){const o=r[1].replace(/\\(\\|f|n|r|t|')/g,c=>w[c]);t.push(o);continue}if(r[2]!==void 0){t.push(parseInt(r[2],10));continue}if(r[3]!==void 0){const o=r[3].replace(/\\(\\')/g,c=>w[c]);t.push({_key:o,_index:-1});continue}}return t}function A(e){return e.map(t=>{if(typeof t=="string"||typeof t=="number")return t;if(t._key!=="")return{_key:t._key};if(t._index!==-1)return t._index;throw new Error(`invalid segment:${JSON.stringify(t)}`)})}function C(e){return e.map(t=>{if(typeof t=="string"||typeof t=="number")return t;if(t._index!==-1)return t._index;throw new Error(`invalid segment:${JSON.stringify(t)}`)})}function T(e,t){if(!t?.mappings)return;const n=q(C(e));if(t.mappings[n]!==void 0)return{mapping:t.mappings[n],matchedPath:n,pathSuffix:""};const r=Object.entries(t.mappings).filter(([p])=>n.startsWith(p)).sort(([p],[i])=>i.length-p.length);if(r.length==0)return;const[o,c]=r[0],s=n.substring(o.length);return{mapping:c,matchedPath:o,pathSuffix:s}}function J(e){return e!==null&&Array.isArray(e)}function U(e){return typeof e=="object"&&e!==null}function d(e,t,n=[]){if(J(e))return e.map((r,o)=>{if(U(r)){const c=r._key;if(typeof c=="string")return d(r,t,n.concat({_key:c,_index:o}))}return d(r,t,n.concat(o))});if(U(e)){if(e._type==="block"||e._type==="span"){const r={...e};return e._type==="block"?r.children=d(e.children,t,n.concat("children")):e._type==="span"&&(r.text=d(e.text,t,n.concat("text"))),r}return Object.fromEntries(Object.entries(e).map(([r,o])=>[r,d(o,t,n.concat(r))]))}return t(e,n)}function N(e,t,n){return d(e,(r,o)=>{if(typeof r!="string")return r;const c=T(o,t);if(!c)return r;const{mapping:s,matchedPath:p}=c;if(s.type!=="value"||s.source.type!=="documentValue")return r;const i=t.documents[s.source.document],a=t.paths[s.source.path],l=v(p),u=v(a).concat(o.slice(l.length));return n({sourcePath:u,sourceDocument:i,resultPath:o,value:r})})}const L="drafts",z="versions",y=".",M=`${L}${y}`,G=`${z}${y}`;function I(e){return e.startsWith(M)}function _(e){return e.startsWith(G)}function V(e){return!I(e)&&!_(e)}function B(e){if(!_(e))return;const[t,n,...r]=e.split(y);return n}function F(e){return _(e)?e.split(y).slice(2).join(y):I(e)?e.slice(M.length):e}function H(e){const{baseUrl:t,workspace:n="default",tool:r="default",id:o,type:c,path:s,projectId:p,dataset:i}=e;if(!t)throw new Error("baseUrl is required");if(!s)throw new Error("path is required");if(!o)throw new Error("id is required");if(t!=="/"&&t.endsWith("/"))throw new Error("baseUrl must not end with a slash");const a=n==="default"?void 0:n,l=r==="default"?void 0:r,u=F(o),h=Array.isArray(s)?j(A(s)):s,f=new URLSearchParams({baseUrl:t,id:u,type:c,path:h});if(a&&f.set("workspace",a),l&&f.set("tool",l),p&&f.set("projectId",p),i&&f.set("dataset",i),V(o))f.set("perspective","published");else if(_(o)){const b=B(o);f.set("perspective",b)}const g=[t==="/"?"":t];a&&g.push(a);const m=["mode=presentation",`id=${u}`,`type=${c}`,`path=${encodeURIComponent(h)}`];return l&&m.push(`tool=${l}`),g.push("intent","edit",`${m.join(";")}?${f}`),g.join("/")}function K(e){let t=typeof e=="string"?e:e.baseUrl;return t!=="/"&&(t=t.replace(/\/$/,"")),typeof e=="string"?{baseUrl:t}:{...e,baseUrl:t}}const x=({sourcePath:e,resultPath:t,value:n})=>{if(X(n)||Y(n))return!1;const r=e.at(-1);return!(e.at(-2)==="slug"&&r==="current"||typeof r=="string"&&(r.startsWith("_")||r.endsWith("Id"))||e.some(o=>o==="meta"||o==="metadata"||o==="openGraph"||o==="seo")||S(e)||S(t)||typeof r=="string"&&Q.has(r))},Q=new Set(["color","colour","currency","email","format","gid","hex","href","hsl","hsla","icon","id","index","key","language","layout","link","linkAction","locale","lqip","page","path","ref","rgb","rgba","route","secret","slug","status","tag","template","theme","type","textTheme","unit","url","username","variant","website"]);function X(e){return/^\d{4}-\d{2}-\d{2}/.test(e)?!!Date.parse(e):!1}function Y(e){try{new URL(e,e.startsWith("/")?"https://acme.com":void 0)}catch{return!1}return!0}function S(e){return e.some(t=>typeof t=="string"&&t.match(/type/i)!==null)}const $=20;function Z(e,t,n){const{filter:r,logger:o,enabled:c}=n;if(!c){const i="config.enabled must be true, don't call this function otherwise";throw o?.error?.(`[@sanity/client]: ${i}`,{result:e,resultSourceMap:t,config:n}),new TypeError(i)}if(!t)return o?.error?.("[@sanity/client]: Missing Content Source Map from response body",{result:e,resultSourceMap:t,config:n}),e;if(!n.studioUrl){const i="config.studioUrl must be defined";throw o?.error?.(`[@sanity/client]: ${i}`,{result:e,resultSourceMap:t,config:n}),new TypeError(i)}const s={encoded:[],skipped:[]},p=N(e,t,({sourcePath:i,sourceDocument:a,resultPath:l,value:u})=>{if((typeof r=="function"?r({sourcePath:i,resultPath:l,filterDefault:x,sourceDocument:a,value:u}):x({sourcePath:i,resultPath:l,value:u}))===!1)return o&&s.skipped.push({path:E(i),value:`${u.slice(0,$)}${u.length>$?"...":""}`,length:u.length}),u;o&&s.encoded.push({path:E(i),value:`${u.slice(0,$)}${u.length>$?"...":""}`,length:u.length});const{baseUrl:h,workspace:f,tool:g}=K(typeof n.studioUrl=="function"?n.studioUrl(a):n.studioUrl);if(!h)return u;const{_id:m,_type:b,_projectId:D,_dataset:O}=a;return W(u,{origin:"sanity.io",href:H({baseUrl:h,workspace:f,tool:g,id:m,type:b,path:i,...!n.omitCrossDatasetReferenceData&&{dataset:O,projectId:D}})},!1)});if(o){const i=s.skipped.length,a=s.encoded.length;if((i||a)&&((o?.groupCollapsed||o.log)?.("[@sanity/client]: Encoding source map into result"),o.log?.(`[@sanity/client]: Paths encoded: ${s.encoded.length}, skipped: ${s.skipped.length}`)),s.encoded.length>0&&(o?.log?.("[@sanity/client]: Table of encoded paths"),(o?.table||o.log)?.(s.encoded)),s.skipped.length>0){const l=new Set;for(const{path:u}of s.skipped)l.add(u.replace(P,"0").replace(/\[\d+\]/g,"[]"));o?.log?.("[@sanity/client]: List of skipped paths",[...l.values()])}(i||a)&&o?.groupEnd?.()}return p}function E(e){return j(A(e))}var te=Object.freeze({__proto__:null,stegaEncodeSourceMap:Z});export{N as encodeIntoResult,Z as stegaEncodeSourceMap,te as stegaEncodeSourceMap$1};
